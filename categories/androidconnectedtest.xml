<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="../assets/xml/rss.xsl" media="all"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title>Adventurous Computing (Posts about androidConnectedTest)</title><link>https://blog.cyplo.net/</link><description></description><atom:link rel="self" type="application/rss+xml" href="https://blog.cyplo.net/categories/androidconnectedtest.xml"></atom:link><language>en</language><lastBuildDate>Tue, 01 Jan 2019 13:56:07 GMT</lastBuildDate><generator>Nikola (getnikola.com)</generator><docs>http://blogs.law.harvard.edu/tech/rss</docs><item><title>Fixing timeouts running Android integration tests</title><link>https://blog.cyplo.net/posts/2015/10/25/android-integration-test-timeouts.html</link><dc:creator>Cyryl Płotnicki</dc:creator><description>&lt;div&gt;&lt;p&gt;The main problem with Android CI I had recently is that, after switching
to Lollipop, the integration tests wouldn't run. Invoking
&lt;strong&gt;androidConnectedTest&lt;/strong&gt; gradle target always resulted in crashing with
&lt;strong&gt;ShellCommandUnresponsiveException&lt;/strong&gt;. Internet says that in such a case
ou just need to set &lt;strong&gt;ADB_INSTALL_TIMEOUT&lt;/strong&gt;. Set and then nothing.
Sourcediving it is then !&lt;/p&gt;
&lt;p&gt;A long while after that I got to this file:
&lt;a class="reference external" href="https://android.googlesource.com/platform/tools/base/+/master/ddmlib/src/main/java/com/android/ddmlib/Device.java"&gt;Device.java&lt;/a&gt; [Linking
to master, here's the commit
hash:1cb1a4c2976b99ae53d28d7f01d975232c85f990, as I don't seem to be
able to find how to link to that hash directly] What do we see there ?
That indeed &lt;strong&gt;ADB_INSTALL_TIMEOUT&lt;/strong&gt; is being used:&lt;/p&gt;
&lt;pre class="code java"&gt;&lt;a name="rest_code_bd4bc19cea1b4483b1fdd06b59585e92-1"&gt;&lt;/a&gt;&lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
&lt;a name="rest_code_bd4bc19cea1b4483b1fdd06b59585e92-2"&gt;&lt;/a&gt;    &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;installTimeout&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;System&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getenv&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"ADB_INSTALL_TIMEOUT"&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
&lt;a name="rest_code_bd4bc19cea1b4483b1fdd06b59585e92-3"&gt;&lt;/a&gt;    &lt;span class="kt"&gt;long&lt;/span&gt; &lt;span class="n"&gt;time&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;a name="rest_code_bd4bc19cea1b4483b1fdd06b59585e92-4"&gt;&lt;/a&gt;    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;installTimeout&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
&lt;a name="rest_code_bd4bc19cea1b4483b1fdd06b59585e92-5"&gt;&lt;/a&gt;        &lt;span class="k"&gt;try&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
&lt;a name="rest_code_bd4bc19cea1b4483b1fdd06b59585e92-6"&gt;&lt;/a&gt;            &lt;span class="n"&gt;time&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Long&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;parseLong&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;installTimeout&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
&lt;a name="rest_code_bd4bc19cea1b4483b1fdd06b59585e92-7"&gt;&lt;/a&gt;        &lt;span class="o"&gt;}&lt;/span&gt; &lt;span class="k"&gt;catch&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;NumberFormatException&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
&lt;a name="rest_code_bd4bc19cea1b4483b1fdd06b59585e92-8"&gt;&lt;/a&gt;            &lt;span class="c1"&gt;// use default value&lt;/span&gt;
&lt;a name="rest_code_bd4bc19cea1b4483b1fdd06b59585e92-9"&gt;&lt;/a&gt;        &lt;span class="o"&gt;}&lt;/span&gt;
&lt;a name="rest_code_bd4bc19cea1b4483b1fdd06b59585e92-10"&gt;&lt;/a&gt;    &lt;span class="o"&gt;}&lt;/span&gt;
&lt;a name="rest_code_bd4bc19cea1b4483b1fdd06b59585e92-11"&gt;&lt;/a&gt;    &lt;span class="n"&gt;INSTALL_TIMEOUT_MINUTES&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;a name="rest_code_bd4bc19cea1b4483b1fdd06b59585e92-12"&gt;&lt;/a&gt;&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;So far so good,
ADB_INSTALL_TIMEOUT system variable seems to be respected when
invoking package installation tools. Are the above the only methods that
can install a package though ? Going further on that hunch we see that
in addition to installing single packages there is a possibility of
having a multi-package installation session.&lt;/p&gt;
&lt;pre class="code java"&gt;&lt;a name="rest_code_655461f70e284baa854bdc454c4736b8-1"&gt;&lt;/a&gt;&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;installPackages&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;apkFilePaths&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;timeOutInMs&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;boolean&lt;/span&gt; &lt;span class="n"&gt;reinstall&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;...&lt;/span&gt; &lt;span class="n"&gt;extraArgs&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;InstallException&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
&lt;a name="rest_code_655461f70e284baa854bdc454c4736b8-2"&gt;&lt;/a&gt;&lt;span class="k"&gt;assert&lt;/span&gt;&lt;span class="o"&gt;(!&lt;/span&gt;&lt;span class="n"&gt;apkFilePaths&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;isEmpty&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt;
&lt;a name="rest_code_655461f70e284baa854bdc454c4736b8-3"&gt;&lt;/a&gt;&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;getApiLevel&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="mi"&gt;21&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
&lt;a name="rest_code_655461f70e284baa854bdc454c4736b8-4"&gt;&lt;/a&gt;        &lt;span class="n"&gt;Log&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;w&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"Internal error : installPackages invoked with device &amp;lt; 21 for %s"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="n"&gt;Joiner&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;on&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;","&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;join&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;apkFilePaths&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;
&lt;a name="rest_code_655461f70e284baa854bdc454c4736b8-5"&gt;&lt;/a&gt;        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;apkFilePaths&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;size&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
&lt;a name="rest_code_655461f70e284baa854bdc454c4736b8-6"&gt;&lt;/a&gt;                &lt;span class="n"&gt;installPackage&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;apkFilePaths&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;),&lt;/span&gt; &lt;span class="n"&gt;reinstall&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;extraArgs&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
&lt;a name="rest_code_655461f70e284baa854bdc454c4736b8-7"&gt;&lt;/a&gt;                &lt;span class="k"&gt;return&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;a name="rest_code_655461f70e284baa854bdc454c4736b8-8"&gt;&lt;/a&gt;        &lt;span class="o"&gt;}&lt;/span&gt;
&lt;a name="rest_code_655461f70e284baa854bdc454c4736b8-9"&gt;&lt;/a&gt;        &lt;span class="n"&gt;Log&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;e&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"Internal error : installPackages invoked with device &amp;lt; 21 for multiple APK : %s"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Joiner&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;on&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;","&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;join&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;apkFilePaths&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;
&lt;a name="rest_code_655461f70e284baa854bdc454c4736b8-10"&gt;&lt;/a&gt;        &lt;span class="k"&gt;throw&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;InstallException&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"Internal error : installPackages invoked with device &amp;lt; 21 for multiple APK : "&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;Joiner&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;on&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;","&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;join&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;apkFilePaths&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;
&lt;a name="rest_code_655461f70e284baa854bdc454c4736b8-11"&gt;&lt;/a&gt;&lt;span class="o"&gt;}&lt;/span&gt;
&lt;a name="rest_code_655461f70e284baa854bdc454c4736b8-12"&gt;&lt;/a&gt;&lt;span class="o"&gt;[...]&lt;/span&gt;
&lt;a name="rest_code_655461f70e284baa854bdc454c4736b8-13"&gt;&lt;/a&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;sessionId&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;createMultiInstallSession&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;apkFilePaths&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;extraArgsList&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;reinstall&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;Aha ! No-Lollipop check here, with a
fallback to the old method - we may be onto something ! Some lines pass
and we can see an invocation of &lt;strong&gt;createMultiInstallSession&lt;/strong&gt;. What's
there ?&lt;/p&gt;
&lt;pre class="code java"&gt;&lt;a name="rest_code_39b1e452593947cab63553632c8d44e6-1"&gt;&lt;/a&gt;&lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="nf"&gt;createMultiInstallSession&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;apkFileNames&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nd"&gt;@NonNull&lt;/span&gt; &lt;span class="n"&gt;Collection&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;extraArgs&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;boolean&lt;/span&gt; &lt;span class="n"&gt;reinstall&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;TimeoutException&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;AdbCommandRejectedException&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ShellCommandUnresponsiveException&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;IOException&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
&lt;a name="rest_code_39b1e452593947cab63553632c8d44e6-2"&gt;&lt;/a&gt;&lt;span class="o"&gt;[...]&lt;/span&gt;
&lt;a name="rest_code_39b1e452593947cab63553632c8d44e6-3"&gt;&lt;/a&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;cmd&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;format&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"pm install-create %1$s -S %2$d"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;parameters&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;toString&lt;/span&gt;&lt;span class="o"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;totalFileSize&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
&lt;a name="rest_code_39b1e452593947cab63553632c8d44e6-4"&gt;&lt;/a&gt;&lt;span class="n"&gt;executeShellCommand&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cmd&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;receiver&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;DdmPreferences&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getTimeOut&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt;
&lt;a name="rest_code_39b1e452593947cab63553632c8d44e6-5"&gt;&lt;/a&gt;&lt;span class="o"&gt;[...]&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;A different invocation of
&lt;strong&gt;executeShellCommand&lt;/strong&gt;, now using &lt;strong&gt;DdmPreferences.getTimeOut()&lt;/strong&gt; as a
timeout value source. Summarizing - this only happens if you install
multiple applications for your androidConnectedTest and you are using
android device to test on that has api version that is equal or greater
to 21. That is all cool that we had this little Computer Science
Investigation, but how to fix that - i.e. how to have proper timeouts
for your installations ? Ideally from somewhere you configure and/or
invoke your builds. It turns out that gradle supports invoking just
enough Java for us to use there. In your &lt;strong&gt;gradle.build&lt;/strong&gt; as the very
first lines:&lt;/p&gt;
&lt;pre class="code groovy"&gt;&lt;a name="rest_code_625b202adafa48dd83ceb47c2cc67a2f-1"&gt;&lt;/a&gt;&lt;span class="n"&gt;println&lt;/span&gt; &lt;span class="s2"&gt;"setting global timeout for apk installation to 10 minutes"&lt;/span&gt;
&lt;a name="rest_code_625b202adafa48dd83ceb47c2cc67a2f-2"&gt;&lt;/a&gt;&lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;android&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;ddmlib&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;DdmPreferences&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;setTimeOut&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;600000&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;a name="rest_code_625b202adafa48dd83ceb47c2cc67a2f-3"&gt;&lt;/a&gt;
&lt;a name="rest_code_625b202adafa48dd83ceb47c2cc67a2f-4"&gt;&lt;/a&gt;&lt;span class="n"&gt;android&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
&lt;a name="rest_code_625b202adafa48dd83ceb47c2cc67a2f-5"&gt;&lt;/a&gt;        &lt;span class="n"&gt;compileSdkVersion&lt;/span&gt; &lt;span class="n"&gt;compileSdk&lt;/span&gt;
&lt;a name="rest_code_625b202adafa48dd83ceb47c2cc67a2f-6"&gt;&lt;/a&gt;        &lt;span class="n"&gt;buildToolsVersion&lt;/span&gt; &lt;span class="n"&gt;buildTools&lt;/span&gt;
&lt;a name="rest_code_625b202adafa48dd83ceb47c2cc67a2f-7"&gt;&lt;/a&gt;&lt;span class="o"&gt;[...]&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;That's it. Invoke your android tests with
&lt;strong&gt;ADB_INSTALL_TIMEOUT&lt;/strong&gt; env variable set &lt;strong&gt;AND&lt;/strong&gt; have the
&lt;strong&gt;DddPreference&lt;/strong&gt; set in your gradle.build as in the example above and
you should be golden. Happy droiding !&lt;/p&gt;&lt;/div&gt;</description><category>adb</category><category>android</category><category>androidConnectedTest</category><category>ci</category><category>ddm</category><category>ddmpreference</category><category>integration tests</category><category>shellcommandunresponsive</category><category>testing</category><guid>https://blog.cyplo.net/posts/2015/10/25/android-integration-test-timeouts.html</guid><pubDate>Sun, 25 Oct 2015 09:55:54 GMT</pubDate></item></channel></rss>